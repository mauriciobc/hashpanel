version: '3.8'

services:
  hashpanel:
    # Build image from Dockerfile instead of using base image
    build:
      context: .
      dockerfile: Dockerfile
    # Alternative: use a pre-built image from registry
    # image: your-registry/hashpanel:latest
    container_name: hashpanel
    restart: always
    # Volumes only for persistent data, not application code
    volumes:
      - hashpanel_data:/app/data
      - hashpanel_logs:/app/logs
    environment:
      # Required Mastodon configuration
      - MASTODON_URL=${MASTODON_URL}
      - CLIENT_KEY=${CLIENT_KEY}
      - CLIENT_SECRET=${CLIENT_SECRET}
      - ACCESS_TOKEN=${ACCESS_TOKEN}
      
      # Server configuration
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - PREFERRED_TIMEZONE=${PREFERRED_TIMEZONE:-America/Sao_Paulo}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Trust proxy configuration (optional, defaults to 1 for secure reverse proxy setup)
      # Set to number of proxies between client and app (typically 1 for Caddy/nginx)
      # Set to 'false' if running directly without reverse proxy
      - TRUST_PROXY=${TRUST_PROXY:-1}
      
      # Database path (persisted in volume)
      - DB_PATH=/app/data/hashpanel.db
      
      # Performance settings (optional, with defaults)
      - API_TIMEOUT_MS=${API_TIMEOUT_MS:-30000}
      - RATE_LIMIT_DELAY_MS=${RATE_LIMIT_DELAY_MS:-1000}
      - MAX_API_PAGES=${MAX_API_PAGES:-20}
      - TOOTS_PER_PAGE=${TOOTS_PER_PAGE:-40}
      
      # Cache settings (optional, with defaults)
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-300}
      - ENABLE_CACHE=${ENABLE_CACHE:-true}
      
      # CORS configuration (required in production)
      # Set CORS_ORIGIN to your domain(s), e.g.:
      # Single domain: CORS_ORIGIN=https://seu-dominio.com
      # Multiple domains: CORS_ORIGIN=https://seu-dominio.com,https://www.seu-dominio.com
      - CORS_ORIGIN=${CORS_ORIGIN}
      
      # Cron schedule (default: 02:00 daily, format: minute hour day month weekday)
      - CRON_SCHEDULE=${CRON_SCHEDULE:-0 2 * * *}
    networks:
      - hashpanel_net
    # No command needed - uses CMD from Dockerfile
    # Entrypoint script handles migrations and cron setup automatically
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      # Healthcheck using the /health endpoint
      # Reduced start_period since no build steps at runtime
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider --timeout=5 http://localhost:3000/health 2>/dev/null || curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
      
  caddy:
    image: caddy:alpine
    container_name: caddy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      - MY_DOMAIN=${MY_DOMAIN}
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - hashpanel_net
    command: >
      sh -c 'echo "${MY_DOMAIN} {
        reverse_proxy hashpanel:3000
      }" > /etc/caddy/Caddyfile && caddy run --config /etc/caddy/Caddyfile'
    depends_on:
      hashpanel:
        condition: service_healthy

networks:
  hashpanel_net:
    driver: bridge

volumes:
  hashpanel_data:
    # Persists database files only (not application code)
  hashpanel_logs:
    # Persists log files
  caddy_data:
  caddy_config:
