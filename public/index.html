<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hashpanel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    body { background: #f0f2f5; padding: 2rem; }
    .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .table { background: white; border-radius: 10px; overflow: hidden; }
    .relevance-badge { background: #4CAF50; color: white; padding: 3px 8px; border-radius: 12px; }
    .trend-chart { width: 100px; height: 40px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">üìä Hashtag Analytics</h1>
    
    <!-- KPI Cards -->
    <div class="row mb-4" id="kpiContainer"></div>
    
    <!-- Top Toots Table -->
    <div class="card p-4 mb-4">
      <h4 class="mb-3">üöÄ Top Performers Today</h4>
      <table class="table table-hover" id="topTootsTable">
        <thead>
          <tr>
            <th>Author</th>
            <th>Followers</th>
            <th>‚≠ê Favorites</th>
            <th>üîÑ Boosts</th>
            <th>Relevance</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Trending Tags Table -->
    <div class="card p-4">
      <h4 class="mb-3">üìà Trending Tags</h4>
      <table class="table table-hover" id="trending-tags-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Uses</th>
            <th>Accounts</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody>
          <!-- Trending tags will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Fetch and render data
    async function loadData() {
      try {
        // Load KPI data
        const statsRes = await fetch('/api/hashtag-stats');
        const { hashtag, todayUses, uniqueUsers, weeklyTotal } = await statsRes.json();
        
        document.getElementById('kpiContainer').innerHTML = `
          <div class="col-md-3">
            <div class="card p-3 bg-primary text-white">
              <h5>#${hashtag}</h5>
              <small>Current Hashtag</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <h2>${todayUses}</h2>
              <small>Today's Posts</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <h2>${uniqueUsers}</h2>
              <small>Unique Users</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <h2>${weeklyTotal}</h2>
              <small>Weekly Total</small>
            </div>
          </div>
        `;

        // Load top toots
        const tootsRes = await fetch('/api/top-toots');
        const topToots = await tootsRes.json();
        
        const tbody = document.querySelector('#topTootsTable tbody');
        tbody.innerHTML = topToots.map(toot => `
          <tr>
            <td>@${toot.author}</td>
            <td>${toot.followers.toLocaleString()}</td>
            <td>${toot.favorites}</td>
            <td>${toot.boosts}</td>
            <td><span class="relevance-badge">${toot.relevance}</span></td>
            <td><a href="${toot.link}" target="_blank">View ‚Üí</a></td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    // Fetch trending tags
    async function fetchTrendingTags() {
      try {
        const response = await fetch('/api/trending-tags');
        const trendingTags = await response.json();
        const tableBody = document.getElementById('trending-tags-table').querySelector('tbody');
        tableBody.innerHTML = '';

        const today = new Date().toISOString().split('T')[0];

        trendingTags.forEach(tag => {
          const todayHistory = tag.history.find(h => {
            const date = new Date(parseInt(h.day) * 1000);
            return date.toISOString().split('T')[0] === today;
          });

          if (!todayHistory) return;

          // Sort history chronologically
          tag.history.sort((a, b) => parseInt(a.day) - parseInt(b.day));

          // Prepare chart data
          const usesData = tag.history.map(h => h.uses);
          const accountsData = tag.history.map(h => h.accounts);
          const maxValue = Math.max(Math.max(...usesData), Math.max(...accountsData)) || 1;

          // Generate SVG points
          const chartPoints = (data) => tag.history
            .map((h, i) => {
              const x = (i * 100) / (tag.history.length - 1 || 1);
              const y = 40 - (data[i] / maxValue) * 40; // 40px height
              return `${x},${y}`;
            })
            .join(' ');

          // Create table row
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><a href="${tag.url}" target="_blank">#${tag.name}</a></td>
            <td>${todayHistory.uses.toLocaleString()}</td>
            <td>${todayHistory.accounts.toLocaleString()}</td>
            <td>
              <svg width="100" height="40" viewBox="0 0 100 40" class="trend-chart">
                <polyline points="${chartPoints(usesData)}" 
                         stroke="#4CAF50" fill="none" stroke-width="1"/>
                <polyline points="${chartPoints(accountsData)}" 
                         stroke="#2196F3" fill="none" stroke-width="1"/>
              </svg>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Error fetching trending tags:', error);
      }
    }

    // Refresh data every 5 minutes
    loadData();
    setInterval(loadData, 300000);

    // Fetch trending tags on page load
    window.onload = fetchTrendingTags;
  </script>
</body>
</html>